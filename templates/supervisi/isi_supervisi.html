{% extends 'base.html' %}
{% block title %}
  Isi Supervisi
{% endblock %}
{% block pagetitle %}
  <i class="fa-solid fa-file-signature me-2"></i>Isi Supervisi
{% endblock %}

{% block content %}
  <style>
    /* ====== gaya khusus halaman ====== */
    .section-card {
      background: #fff;
      border: 1px solid rgba(13, 110, 253, 0.1);
      border-radius: 18px;
      box-shadow: 0 12px 28px rgba(13, 110, 253, 0.06);
      padding: 18px;
    }
    .form-soft .form-control,
    .form-soft .form-select {
      border-radius: 12px;
      border: 1px solid rgba(13, 110, 253, 0.15);
    }
    .form-soft label {
      font-weight: 700;
      color: #0f1e3a;
    }
    
    /* tabel */
    .table-wrap {
      background: #fff;
      border: 1px solid rgba(13, 110, 253, 0.1);
      border-radius: 18px;
      box-shadow: 0 10px 24px rgba(13, 110, 253, 0.06);
      overflow: hidden;
    }
    table.super {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    table.super thead th {
      background: linear-gradient(135deg, #4a90e2, #357abd);
      color: #fff;
      font-weight: 700;
      text-align: center;
      padding: 0.75rem 0.75rem;
      border: 0;
    }
    table.super tbody td {
      background: #fff;
      border-top: 1px solid #eef2ff;
      vertical-align: top;
      padding: 0.75rem 0.8rem;
    }
    table.super tbody tr:nth-child(even) td {
      background: #fbfdff;
    }
    table.super td.checkbox-cell {
      text-align: center;
      width: 10%;
    }
    table.super td:first-child {
      width: 40%;
    }
    table.super td:nth-child(2) {
      width: 40%;
    }
    
    /* checkbox lebih besar */
    .form-check-input.super-check {
      transform: scale(1.15);
      cursor: pointer;
      box-shadow: none;
    }
    
    /* tombol simpan gaya biru */
    .btn-primary.soft {
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 6px 16px rgba(13, 110, 253, 0.25);
    }
    
    /* ==== Upload box (Drag & Drop) ==== */
    .upload-box {
      border: 2px dashed #cfe0ff;
      border-radius: 14px;
      background: #f7fbff;
      padding: 24px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .upload-box:hover {
      background: #f1f7ff;
      border-color: #9ec2ff;
    }
    .upload-box.dragover {
      background: #e9f2ff;
      border-color: #5a96ff;
    }
    .upload-box i {
      font-size: 34px;
      color: #6c8cff;
    }
    .upload-hint {
      color: #6b7280;
      font-size: 0.85rem;
    }
    .preview-wrap img {
      max-height: 120px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 4px;
      background: #fff;
    }
  </style>

  <div class="section-card mb-3">
    <div class="d-flex align-items-center gap-3 flex-wrap">
      <div class="rounded-3 d-flex align-items-center justify-content-center" style="width:48px;height:48px;background:rgba(13,110,253,.12);color:#0d6efd;">
        <i class="fa-solid fa-clipboard-list"></i>
      </div>
      <div class="flex-grow-1">
        <h5 class="mb-0 fw-bold">{{ format.nama }}</h5>
        <div class="text-muted small">Form Supervisi</div>
      </div>
    </div>
  </div>

  <!-- enctype WAJIB untuk upload -->
  <form method="post" class="form-soft" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Identitas -->
    <div class="section-card mb-3">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">TIM</label>
          <select name="tim" class="form-select" required>
            <option value="">-- Pilih Tim --</option>
            <option value="1">Tim 1</option>
            <option value="2">Tim 2</option>
            <option value="3">Tim 3</option>
            <option value="4">Tim 4</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Jenjang PK</label>
          <input type="text" name="jenjang_pk" class="form-control" placeholder="Masukkan jenjang PK" required />
        </div>
        <div class="col-md-4">
          <label class="form-label">Ruang</label>
          <input type="text" name="ruang" class="form-control" value="Imdad Hamid Lantai 2" required />
        </div>
      </div>
    </div>

    <!-- Tabel -->
    <div class="table-wrap mb-3">
      <div class="table-responsive">
        <table class="super">
          <thead>
            <tr>
              <th>Prosedur</th>
              <th>Aspek</th>
              <th>D</th>
              <th>TD</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              {% for aspek in item.aspek.all %}
                <tr>
                  {% if forloop.first %}
                    <td rowspan="{{ item.aspek.count }}" class="align-top">{{ item.pertanyaan }}</td>
                  {% endif %}
                  <td>{{ aspek.nama_aspek }}</td>
                  <td class="checkbox-cell">
                    <input type="checkbox" name="d_{{ aspek.id }}" class="form-check-input super-check" onclick="toggleCheck('{{ aspek.id }}', 'd')" />
                  </td>
                  <td class="checkbox-cell">
                    <input type="checkbox" name="td_{{ aspek.id }}" class="form-check-input super-check" onclick="toggleCheck('{{ aspek.id }}', 'td')" />
                  </td>
                </tr>
              {% endfor %}
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted">Belum ada data supervisi</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Nama Perawat -->
    <div class="section-card mb-3">
      <label class="form-label" for="perawatNamaInput">
        Nama Perawat (untuk dokumen)
      </label>
      <input
        type="text"
        name="perawat_nama"
        id="perawatNamaInput"
        class="form-control"
        placeholder="Masukkan nama lengkap perawat"
        value="{{ default_perawat_nama }}"
        required
      />
      <div class="form-text text-muted mt-1">
        Nama ini akan muncul pada dokumen PDF hasil supervisi.
      </div>
    </div>

    <!-- TTD Perawat -->
    <div class="section-card">
      <label class="form-label d-block mb-2">Tanda Tangan Perawat</label>
      <div id="dropZoneTTD" class="upload-box">
        <i class="fa-solid fa-cloud-arrow-up"></i>
        <p class="mb-1 fw-semibold" id="uploadText">Klik untuk upload atau drag &amp; drop</p>
        <small class="upload-hint">Format: PNG, JPG (Max: 5MB)</small>
        <input id="ttdInput" type="file" name="ttd_perawat" accept="image/*" hidden />
      </div>
      <div id="previewTTD" class="mt-3 preview-wrap" style="display:none;">
        <div class="text-muted small mb-1">Preview tanda tangan:</div>
        <img id="previewImg" src="#" alt="Preview TTD" />
      </div>
    </div>

    <!-- Submit -->
    <div class="text-end mt-3">
      <button type="submit" class="btn btn-primary soft px-4"><i class="fa-solid fa-floppy-disk me-1"></i> Simpan</button>
    </div>
  </form>

  <script>
    // Lock D/TD mutually exclusive
    function toggleCheck(id, type) {
      const dCheck = document.querySelector(`[name='d_${id}']`)
      const tdCheck = document.querySelector(`[name='td_${id}']`)
      if (type === 'd' && dCheck.checked) tdCheck.checked = false
      if (type === 'td' && tdCheck.checked) dCheck.checked = false
    }
    
    // Drag & Drop TTD Perawat
    const dz = document.getElementById('dropZoneTTD')
    const input = document.getElementById('ttdInput')
    const previewWrap = document.getElementById('previewTTD')
    const previewImg = document.getElementById('previewImg')
    const uploadText = document.getElementById('uploadText')
    
    function handleFiles(file) {
      if (!file) return
      const okTypes = ['image/png', 'image/jpeg', 'image/jpg']
      if (!okTypes.includes(file.type)) {
        alert('Format harus PNG/JPG')
        input.value = ''
        return
      }
      if (file.size > 5 * 1024 * 1024) {
        alert('Ukuran maksimal 5MB')
        input.value = ''
        return
      }
      uploadText.textContent = file.name
      const reader = new FileReader()
      reader.onload = (e) => {
        previewImg.src = e.target.result
        previewWrap.style.display = ''
      }
      reader.readAsDataURL(file)
    }
    
    dz.addEventListener('click', () => input.click())
    input.addEventListener('change', (e) => handleFiles(e.target.files[0]))
    ;['dragenter', 'dragover'].forEach((evt) =>
      dz.addEventListener(evt, (e) => {
        e.preventDefault()
        e.stopPropagation()
        dz.classList.add('dragover')
      })
    )
    ;['dragleave', 'drop'].forEach((evt) =>
      dz.addEventListener(evt, (e) => {
        e.preventDefault()
        e.stopPropagation()
        dz.classList.remove('dragover')
      })
    )
    dz.addEventListener('drop', (e) => {
      const file = e.dataTransfer.files && e.dataTransfer.files[0]
      if (file) {
        input.files = e.dataTransfer.files
        handleFiles(file)
      }
    })
  </script>
{% endblock %}
