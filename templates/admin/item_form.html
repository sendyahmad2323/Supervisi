{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Form Format Supervisi{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center">Form Format Supervisi</h2>
    
    <form method="post">
        {% csrf_token %}
        <table class="table table-bordered" id="supervisiTable">
            <thead class="table-light text-center">
                <tr>
                    <th>Prosedur</th>
                    <th>Aspek yang Dinilai</th>
                    <th>D</th>
                    <th>TD</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="prosedurContainer">
                <!-- Prosedur awal -->
                <tr class="prosedur-row">
                    <td>
                        <input type="text" name="prosedur_0" class="form-control" placeholder="Masukkan prosedur">
                    </td>
                    <td>
                        <div class="aspekContainer">
                            <div class="mb-2 d-flex">
                                <input type="text" name="aspek_0_0" class="form-control me-2" placeholder="Masukkan aspek">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm mt-2 add-aspek">Tambah Aspek</button>
                    </td>
                    <td>
                        <div class="d-flex flex-column aspekDContainer">
                            <div class="mb-2 text-center">
                                <input type="checkbox" name="d_0_0" class="form-check-input">
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-column aspekTDContainer">
                            <div class="mb-2 text-center">
                                <input type="checkbox" name="td_0_0" class="form-check-input">
                            </div>
                        </div>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm remove-prosedur">Hapus Prosedur</button>
                    </td>
                </tr>
            </tbody>
        </table>

        <button type="button" class="btn btn-success mb-3" id="addProsedur">Tambah Prosedur</button>

        <!-- Tempat TTD -->
        <div class="row mt-5">
            <div class="col-md-6 text-center">
                <p>Perawat yang disupervisi</p>
                <br><br>
                <p>________________________</p>
            </div>
            <div class="col-md-6 text-center">
                <p>Supervisor</p>
                <br><br>
                <p>Ns. Rike Sebrianti, S.Kep., M.Kep</p>
                <p>NIP : 19821122200801</p>
            </div>
        </div>

        <button type="submit" class="btn btn-success mt-4 w-100">Simpan</button>
    </form>
</div>

<script>
let prosedurCount = 1;  // jumlah prosedur
let aspekCounts = [1];   // jumlah aspek per prosedur (index = prosedur)

function createAspekInput(prosedurIndex, aspekIndex) {
    // div input aspek
    const divAspek = document.createElement('div');
    divAspek.classList.add('mb-2', 'd-flex');
    divAspek.innerHTML = `<input type="text" name="aspek_${prosedurIndex}_${aspekIndex}" class="form-control me-2" placeholder="Masukkan aspek">`;

    // div checkbox D
    const divD = document.createElement('div');
    divD.classList.add('mb-2', 'text-center');
    divD.innerHTML = `<input type="checkbox" name="d_${prosedurIndex}_${aspekIndex}" class="form-check-input">`;

    // div checkbox TD
    const divTD = document.createElement('div');
    divTD.classList.add('mb-2', 'text-center');
    divTD.innerHTML = `<input type="checkbox" name="td_${prosedurIndex}_${aspekIndex}" class="form-check-input">`;

    return { divAspek, divD, divTD };
}

// Tambah prosedur baru
document.getElementById('addProsedur').addEventListener('click', function() {
    const container = document.getElementById('prosedurContainer');
    const row = document.createElement('tr');
    row.classList.add('prosedur-row');

    row.innerHTML = `
        <td><input type="text" name="prosedur_${prosedurCount}" class="form-control" placeholder="Masukkan prosedur"></td>
        <td><div class="aspekContainer"></div><button type="button" class="btn btn-primary btn-sm mt-2 add-aspek">Tambah Aspek</button></td>
        <td><div class="d-flex flex-column aspekDContainer"></div></td>
        <td><div class="d-flex flex-column aspekTDContainer"></div></td>
        <td class="text-center"><button type="button" class="btn btn-danger btn-sm remove-prosedur">Hapus Prosedur</button></td>
    `;
    container.appendChild(row);

    // buat 1 aspek default
    const { divAspek, divD, divTD } = createAspekInput(prosedurCount, 0);
    row.querySelector('.aspekContainer').appendChild(divAspek);
    row.querySelector('.aspekDContainer').appendChild(divD);
    row.querySelector('.aspekTDContainer').appendChild(divTD);

    aspekCounts[prosedurCount] = 1;
    prosedurCount++;
});

// Tambah aspek baru
document.addEventListener('click', function(e) {
    if(e.target && e.target.classList.contains('add-aspek')) {
        const row = e.target.closest('tr');
        const index = Array.from(document.querySelectorAll('.prosedur-row')).indexOf(row);
        const aspekIndex = aspekCounts[index];

        const { divAspek, divD, divTD } = createAspekInput(index, aspekIndex);
        row.querySelector('.aspekContainer').appendChild(divAspek);
        row.querySelector('.aspekDContainer').appendChild(divD);
        row.querySelector('.aspekTDContainer').appendChild(divTD);

        aspekCounts[index]++;
    }

    // Hapus prosedur
    if(e.target && e.target.classList.contains('remove-prosedur')){
        const row = e.target.closest('tr');
        const index = Array.from(document.querySelectorAll('.prosedur-row')).indexOf(row);
        aspekCounts.splice(index, 1);
        row.remove();
    }
});
</script>
{% endblock %}
